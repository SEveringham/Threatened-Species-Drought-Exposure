---
title: "Drought Exposure Analysis"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
date: "2024-05-16"
---

Libraries required
```{r, message = F, warning = F}
library(tidyverse)
library(ggplot2)
library(Hmisc)
library(ggridges)
```

Read in data
```{r}
droughtdata <- read.csv("Data/Data Used in Analyses/droughtdataforanalyses.csv")
```


## Figures 

To determine the exposure of drought to species listed as threatened on the IUCN redlist

We are starting off with 9746 species because we have previously filtered out aquatic species that aren't biologically impacted by terrestrial drought

### Robustness of drought data

Firstly Looking at the robustness of drought data which species' extent of occurrences (EOO)

Doing this for both IPCC scenarios SSP 2-4.5 (245 in data) and SSP 5-8.5 (585 in data)

```{r,figures-side, fig.show="hold", out.width="50%", message = F}
robustnessofdroughtprojection245 <- ggplot(data=droughtdata, aes(x =duration_245_proportion_non_robust.x, fill = "#53619E")) +
  geom_histogram(colour = "grey40", bins = 100) +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=0.15,
    y=8000,
  size = 10) +
  theme_classic(base_size =15) +
  labs(y = "Count of Species (log10 transformed)", x = "Proportion of a species' extent of occurrence that is a non-robust area \n (i.e. DOESN'T fall into robust drought projections pixel)") +
  scale_fill_manual(values =  "#53619E")+
  scale_y_continuous(trans = "log10") +
  guides(fill="none")
  
plot(robustnessofdroughtprojection245)

#quick count of species we can't include for scenario 245
sum(droughtdata$duration_245_proportion_non_robust.x == 1)
#5213 species we cannot use!

robustnessofdroughtprojection585 <- ggplot(data=droughtdata, aes(x =duration_585_proportion_non_robust.x,fill = "#53619E")) +
  geom_histogram(colour = "grey40", bins = 100) +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=0.15,
    y=8000,
    size = 10
  ) +
  theme_classic(base_size = 15) +
  labs(y = "", x = "Proportion of a species' extent of occurrence that is a non-robust area \n (i.e. DOESN'T fall into robust drought projections pixel)") +
  scale_y_continuous(trans = "log10") +
  scale_fill_manual(values =  "#53619E")+
  guides(fill="none")
  
  
plot(robustnessofdroughtprojection585)

#quick count of species we can't include for scenario 585
sum(droughtdata$duration_585_proportion_non_robust.x == 1)
#3635 species we cannot use for scenario 3324!

#quick count of how many species we can't use altoghter
sum(droughtdata$duration_245_proportion_non_robust.x == 1 &
      droughtdata$duration_585_proportion_non_robust.x == 1)
#3465 species have no range in robust drought projection areas for either scenario

#remove these species where there is no range at all in robust areas
droughtdatarobust <- droughtdata %>%
  filter(!(droughtdata$duration_245_proportion_non_robust.x == 1 &
      droughtdata$duration_585_proportion_non_robust.x == 1))
```

Now we are left with 6281 species with extents of occurrence in at least a small proportion of their range in a robust drought projected area for either scenario

With these species let's have a look at their proportion of distribution in future drought projection changes.

### Drought Duration

#### Histograms and proportions

First we are going to have a look at the distribution of the number of species i.e. the proportion of species whose ranges fall into areas that will increase in drought duration or decrease in drought duration (or show no change - 0) into the future

Simple violin plot of increasing or decreasing proportion

```{r, fig.show="hold", out.width="50%", message = F}
#scenario SPP 2-4.5
proportiondroughtdurationincreasingordecreasing245 <- droughtdatarobust %>%
  select(scientificName, duration_245_proportion_positive_value.x, duration_245_proportion_negative_value.x) %>%
  filter(!(duration_245_proportion_positive_value.x== 0 & 
           duration_245_proportion_negative_value.x == 0)) %>% #filtering the species that didn't have robust data for this scenario (but still in df to use for other scenario)
  pivot_longer(!scientificName, names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = log10(proportion+0.00001), fill = positiveornegative)) +
  geom_violin(width = 1) +
  scale_x_discrete(breaks=c("duration_245_proportion_positive_value.x","duration_245_proportion_negative_value.x"),
        labels=c("Increase in Drought Duration", "Decrease in Drought Duration")) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "positiveornegative", values = c("#53619E", "#7D5D3A")) +
    theme_classic(base_size = 15) +
  guides(fill="none") +
  labs(y = "Proportion of each species' range that \n falls into drought duration change \n (log10 trans.)", x = "") +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=0.8,
    y=1,
    size = 10
  )
proportiondroughtdurationincreasingordecreasing245

#scenario SPP 5 - 8.5
proportiondroughtdurationincreasingordecreasing585 <- droughtdatarobust %>%
  select(scientificName, duration_585_proportion_positive_value.x, duration_585_proportion_negative_value.x) %>%
  filter(!(duration_585_proportion_positive_value.x== 0 & 
           duration_585_proportion_negative_value.x == 0)) %>% #filtering the species that didn't have robust data for this scenario (but still in df to use for other scenario)
  pivot_longer(!scientificName, names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = log10(proportion+0.00001), fill = positiveornegative)) +
  geom_violin(width = 1) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "positiveornegative", values = c("#53619E", "#7D5D3A")) +
  scale_x_discrete(breaks=c("duration_585_proportion_positive_value.x","duration_585_proportion_negative_value.x"),
        labels=c("Increase in Drought Duration", "Decrease in Drought Duration")) +
  theme_classic(base_size = 15) +
  guides(fill="none") +
  labs(y = "", x = "") +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=0.8,
    y=1,
    size = 10
  )
proportiondroughtdurationincreasingordecreasing585
```
Now same plots but with JUST threatened species (vulnerable, endangered, critically endangered) and comparing these groups

```{r, fig.show="hold", out.width="50%", message = F}
#scenario SPP 2-4.5
threatenedspeciesprop245 <- droughtdatarobust %>%
  select(scientificName, category.x, duration_245_proportion_positive_value.x, duration_245_proportion_negative_value.x) %>%
  filter(category.x == "VU" | category.x == "EN" | category.x == "CR") %>%
   pivot_longer(!c(scientificName, category.x), names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = log10(proportion+0.00001), fill = category.x)) +
  geom_violin(aes(fill= category.x), width = 1) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = category.x),
    position=position_dodge(1),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "category.x", values = c("#D52001", "#FC7F3F", "#F9E814")) +
  guides(fill = "none") +
    theme_classic(base_size = 15) +
   scale_x_discrete(breaks=c("duration_245_proportion_positive_value.x","duration_245_proportion_negative_value.x"), labels=c("Increase in Drought Duration", "Decrease in Drought Duration")) +
  labs(y = "Proportion of each species' range that \n falls into drought duration change \n (log10 trans.)", x = "") +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=0.8,
    y=1,
    size = 10
  )
    
threatenedspeciesprop245

#scenario SPP 5-8.5
threatenedspeciesprop585 <- droughtdatarobust %>%
  select(scientificName, category.x, duration_585_proportion_positive_value.x, duration_585_proportion_negative_value.x) %>%
  filter(category.x == "VU" | category.x == "EN" | category.x == "CR") %>%
   pivot_longer(!c(scientificName, category.x), names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = log10(proportion+0.00001), fill = category.x)) +
  geom_violin(aes(fill= category.x), width = 1) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = category.x),
    position=position_dodge(1),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "category.x", values = c("#D52001", "#FC7F3F", "#F9E814")) +
   scale_x_discrete(breaks=c("duration_585_proportion_positive_value.x","duration_585_proportion_negative_value.x"),
        labels=c("Increase in Drought Duration", "Decrease in Drought Duration")) +
    theme_classic(base_size = 15) +
  labs(y = "", x = "") +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=0.9,
    y=1,
    size = 10
  )
threatenedspeciesprop585


```

#### Density plots of duration change

gives a bit more detail - not just a binary negative or positive as above

```{r, fig.show="hold", out.width="50%", message = F}
#scenario SPP 2-4.5
durationdensity245 <- droughtdatarobust %>%
  filter(category.x == "CR" | category.x == "EN" | category.x == "VU") %>%
  ggplot(aes(x = duration_245_mean.x, y = category.x, fill = category.x)) +
  geom_density_ridges(scale = 2, alpha = 0.8, quantile_lines = T, quantile_fun = mean) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "#F9E814")) +
  guides(fill = "none") +
  xlab("Mean Drought Duration Change for SSP 2-4.5 Projection (months)") +
  ylab("") +
  theme_ridges() +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=-0.4,
    y=4.5,
    size = 9
  )

durationdensity245

#scenario SSP 5-8.5
durationdensity585 <- droughtdatarobust %>%
  filter(category.x == "CR" | category.x == "EN" | category.x == "VU") %>%
  ggplot(aes(x = duration_585_mean.x, y = category.x, fill = category.x)) +
  geom_density_ridges(scale = 2, alpha = 0.8, quantile_lines = T, quantile_fun = mean) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "#F9E814")) +
  guides(fill = "none") +
  xlab("Mean Drought Duration Change for SSP 5-8.5 Projection (months)") +
  ylab("") +
  theme_ridges() +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=-0.4,
    y=4.2,
    size = 9
  )

durationdensity585
```

### Drought Frequency

#### Histograms and proportions

Same as above with drought frequency instead of duration

Simple violin plot of increasing or decreasing proportion

```{r, fig.show="hold", out.width="50%", message = F}
#scenario SPP 2-4.5
proportiondroughtfrequencyincreasingordecreasing245 <- droughtdatarobust %>%
  select(scientificName, frequency_245_proportion_positive_value.x, frequency_245_proportion_negative_value.x) %>%
  filter(!(frequency_245_proportion_positive_value.x== 0 & 
           frequency_245_proportion_negative_value.x == 0)) %>% #filtering the species that didn't have robust data for this scenario (but still in df to use for other scenario)
  pivot_longer(!scientificName, names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = log10(proportion+0.00001), fill = positiveornegative)) +
  geom_violin(width = 1) +
  scale_x_discrete(breaks=c("frequency_245_proportion_positive_value.x","frequency_245_proportion_negative_value.x"),
        labels=c("Increase in Drought Frequency", "Decrease in Drought Frequency")) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "positiveornegative", values = c("#53619E", "#7D5D3A")) +
    theme_classic(base_size = 15) +
  guides(fill="none") +
  labs(y = "Proportion of each species' range that \n falls into drought frequency change \n (log10 trans.)", x = "") +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=0.8,
    y=1,
    size = 10
  )
proportiondroughtfrequencyincreasingordecreasing245

#scenario SPP 5 - 8.5
proportiondroughtfrequencyincreasingordecreasing585 <- droughtdatarobust %>%
  select(scientificName, frequency_585_proportion_positive_value.x, frequency_585_proportion_negative_value.x) %>%
  filter(!(frequency_585_proportion_positive_value.x== 0 & 
           frequency_585_proportion_negative_value.x == 0)) %>% #filtering the species that didn't have robust data for this scenario (but still in df to use for other scenario)
  pivot_longer(!scientificName, names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = log10(proportion+0.00001), fill = positiveornegative)) +
  geom_violin(width = 1) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "positiveornegative", values = c("#53619E", "#7D5D3A")) +
  scale_x_discrete(breaks=c("frequency_585_proportion_positive_value.x","frequency_585_proportion_negative_value.x"),
        labels=c("Increase in Drought frequency", "Decrease in Drought frequency")) +
  theme_classic(base_size = 15) +
  guides(fill="none") +
  labs(y = "", x = "") +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=0.8,
    y=1,
    size = 10
  )
proportiondroughtfrequencyincreasingordecreasing585
```
Now same plots but with JUST threatened species (vulnerable, endangered, critically endangered) and comparing these groups

```{r, fig.show="hold", out.width="50%", message = F}
#scenario SPP 2-4.5
threatenedspeciesprop245 <- droughtdatarobust %>%
  select(scientificName, category.x, frequency_245_proportion_positive_value.x, frequency_245_proportion_negative_value.x) %>%
  filter(category.x == "VU" | category.x == "EN" | category.x == "CR") %>%
   pivot_longer(!c(scientificName, category.x), names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = proportion, fill = category.x)) +
  geom_violin(aes(fill= category.x), width = 1.2) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = category.x),
    position=position_dodge(1.2),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "category.x", values = c("#D52001", "#FC7F3F", "#F9E814")) +
  guides(fill = "none") +
    theme_classic(base_size = 15) +
   scale_x_discrete(breaks=c("frequency_245_proportion_positive_value.x","frequency_245_proportion_negative_value.x"), labels=c("Increase in Drought frequency", "Decrease in Drought frequency")) +
  labs(y = "Proportion of each species' range that \n falls into drought frequency change \n (log10 trans.)", x = "") +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=0.8,
    y=1.1,
    size = 10
  )
    
threatenedspeciesprop245

#scenario SPP 5-8.5
threatenedspeciesprop585 <- droughtdatarobust %>%
  select(scientificName, category.x, frequency_585_proportion_positive_value.x, frequency_585_proportion_negative_value.x) %>%
  filter(category.x == "VU" | category.x == "EN" | category.x == "CR") %>%
   pivot_longer(!c(scientificName, category.x), names_to = "positiveornegative", values_to = "proportion") %>%
  ggplot(aes(x = positiveornegative, y = proportion, fill = category.x)) +
  geom_violin(aes(fill= category.x), width = 1.2) +
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    aes(group = category.x),
    position=position_dodge(1.2),
    geom = "pointrange", color = "black") +
    scale_fill_manual(name = "category.x", values = c("#D52001", "#FC7F3F", "#F9E814")) +
   scale_x_discrete(breaks=c("frequency_585_proportion_positive_value.x","frequency_585_proportion_negative_value.x"),
        labels=c("Increase in Frequency", "Decrease in Frequency")) +
    theme_classic(base_size = 15) +
  labs(y = "", x = "") +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=0.9,
    y=1.1,
    size = 10
  )
threatenedspeciesprop585
```

#### Density plots of frequency change

gives a bit more detail - not just a binary negative or positive as above

```{r, fig.show="hold", out.width="50%", message = F}
#scenario SPP 2-4.5
frequencydensity245 <- droughtdatarobust %>%
  filter(category.x == "CR" | category.x == "EN" | category.x == "VU") %>%
  ggplot(aes(x = frequency_245_mean.x, y = category.x, fill = category.x)) +
  geom_density_ridges(scale = 2, alpha = 0.8, quantile_lines = T, quantile_fun = mean) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "#F9E814")) +
  guides(fill = "none") +
  xlab("Mean Drought Frequency Change for SSP 2-4.5 Projection (Events per ??y)") +
  ylab("") +
  theme_ridges() +
  ggplot2::annotate("text",
    label="SSP 2 - 4.5", 
    x=-0.4,
    y=4.5,
    size = 9
  )

frequencydensity245

#scenario SSP 5-8.5
frequencydensity585 <- droughtdatarobust %>%
  filter(category.x == "CR" | category.x == "EN" | category.x == "VU") %>%
  ggplot(aes(x = frequency_585_mean.x, y = category.x, fill = category.x)) +
  geom_density_ridges(scale = 2, alpha = 0.8, quantile_lines = T, quantile_fun = mean) + 
  scale_y_discrete(expand = c(0, 0)) +     # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) +   # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  scale_fill_manual(values = c("#D52001", "#FC7F3F", "#F9E814")) +
  guides(fill = "none") +
  xlab("Mean Drought Frequency Change for SSP 5-8.5 Projection (Events per ??y)") +
  ylab("") +
  theme_ridges() +
  ggplot2::annotate("text",
    label="SSP 5 - 8.5", 
    x=-0.5,
    y=4.8,
    size = 9
  )

frequencydensity585
```
